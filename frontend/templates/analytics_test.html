<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†ææµ‹è¯•é¡µé¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-chart-bar me-2"></i>K12è‹±è¯­çŸ¥è¯†å›¾è°± - æ•°æ®åˆ†ææµ‹è¯•</h1>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>AI Agentæ¨¡å‹å‡†ç¡®ç‡åˆ†æ</h5>
                        <button class="btn btn-primary btn-sm" onclick="loadAccuracyAnalysis()">
                            <i class="fas fa-refresh me-1"></i>åˆ·æ–°æ•°æ®
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="accuracy-analysis">
                            <div class="text-center">
                                <button class="btn btn-outline-primary" onclick="loadAccuracyAnalysis()">
                                    <i class="fas fa-chart-line me-1"></i>åŠ è½½AI Agentå‡†ç¡®ç‡åˆ†æ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>çŸ¥è¯†ç‚¹è¦†ç›–åˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        <div id="coverage-analysis">
                            <button class="btn btn-outline-info" onclick="loadCoverageAnalysis()">
                                <i class="fas fa-chart-pie me-1"></i>åŠ è½½è¦†ç›–åˆ†æ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>é¢˜ç›®åˆ†å¸ƒåˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        <div id="distribution-analysis">
                            <button class="btn btn-outline-success" onclick="loadDistributionAnalysis()">
                                <i class="fas fa-chart-bar me-1"></i>åŠ è½½åˆ†å¸ƒåˆ†æ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>æ‰€æœ‰é¢˜ç›®åˆ—è¡¨</h5>
                        <button class="btn btn-success btn-sm" onclick="loadAllQuestions()">
                            <i class="fas fa-list me-1"></i>åŠ è½½æ‰€æœ‰é¢˜ç›®
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="questions-list">
                            <div class="text-center text-muted">
                                <i class="fas fa-question-circle fa-3x mb-3"></i>
                                <p>ç‚¹å‡»æŒ‰é’®åŠ è½½é¢˜ç›®åˆ—è¡¨</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api';
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(containerId, message = 'åŠ è½½ä¸­...') {
            document.getElementById(containerId).innerHTML = `
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // åŠ è½½AI Agentå‡†ç¡®ç‡åˆ†æ
        async function loadAccuracyAnalysis() {
            try {
                showLoading('accuracy-analysis', 'æ­£åœ¨åˆ†æAI Agentå‡†ç¡®ç‡...');
                
                const response = await fetch(`${API_BASE_URL}/analytics/ai-agent-accuracy`);
                const data = await response.json();
                
                const accuracy = data.accuracy_analysis || {};
                const details = accuracy.details || [];
                
                const html = `
                    <div class="alert alert-primary">
                        <h6><i class="fas fa-robot me-2"></i>AI Agentæ€§èƒ½æŒ‡æ ‡</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>å‡†ç¡®ç‡:</strong> ${accuracy.accuracy_rate || 0}%
                            </div>
                            <div class="col-md-3">
                                <strong>æ­£ç¡®æ ‡æ³¨:</strong> ${accuracy.correct_annotations || 0}
                            </div>
                            <div class="col-md-3">
                                <strong>æ€»æ ‡æ³¨æ•°:</strong> ${accuracy.total_annotations || 0}
                            </div>
                            <div class="col-md-3">
                                <strong>è¦†ç›–ç‡:</strong> ${data.coverage_rate?.toFixed(1) || 0}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>é¢˜ç›®å†…å®¹</th>
                                    <th>AIæ ‡æ³¨</th>
                                    <th>æœŸæœ›æ ‡æ³¨</th>
                                    <th>å‡†ç¡®æ€§</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${details.map(detail => `
                                    <tr>
                                        <td>${detail.content}</td>
                                        <td>${detail.annotated_kps.join(', ')}</td>
                                        <td>${detail.expected_kps.join(', ') || 'æ— '}</td>
                                        <td>
                                            ${detail.is_accurate ? 
                                                '<span class="badge bg-success">âœ… æ­£ç¡®</span>' : 
                                                '<span class="badge bg-danger">âŒ é”™è¯¯</span>'
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('accuracy-analysis').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½å‡†ç¡®ç‡åˆ†æå¤±è´¥:', error);
                showError('accuracy-analysis', 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åŠ è½½çŸ¥è¯†ç‚¹è¦†ç›–åˆ†æ
        async function loadCoverageAnalysis() {
            try {
                showLoading('coverage-analysis', 'æ­£åœ¨åˆ†æçŸ¥è¯†ç‚¹è¦†ç›–...');
                
                const response = await fetch(`${API_BASE_URL}/analytics/coverage`);
                const data = await response.json();
                
                const coverageData = data.coverage_data || [];
                const summary = data.summary || {};
                
                const html = `
                    <div class="mb-3">
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: ${summary.coverage_rate || 0}%">
                                è¦†ç›–ç‡: ${summary.coverage_rate || 0}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${coverageData.map(kp => `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div>
                                    <strong>${kp.knowledge_point}</strong>
                                    <br><small class="text-muted">${kp.level || 'æœªè®¾ç½®'}</small>
                                </div>
                                <span class="badge ${kp.question_count > 0 ? 'bg-success' : 'bg-secondary'}">
                                    ${kp.question_count} é¢˜
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('coverage-analysis').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½è¦†ç›–åˆ†æå¤±è´¥:', error);
                showError('coverage-analysis', 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åŠ è½½åˆ†å¸ƒåˆ†æ
        async function loadDistributionAnalysis() {
            try {
                showLoading('distribution-analysis', 'æ­£åœ¨åˆ†æé¢˜ç›®åˆ†å¸ƒ...');
                
                const [difficultyResponse, typeResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/analytics/difficulty-distribution`),
                    fetch(`${API_BASE_URL}/analytics/type-distribution`)
                ]);
                
                const difficultyData = await difficultyResponse.json();
                const typeData = await typeResponse.json();
                
                const html = `
                    <h6>éš¾åº¦åˆ†å¸ƒ:</h6>
                    ${(difficultyData.difficulty_distribution || []).map(item => `
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>${item.difficulty || 'æœªè®¾ç½®'}</span>
                                <span>${item.count} é¢˜ (${item.percentage?.toFixed(1) || 0}%)</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" 
                                     style="width: ${item.percentage || 0}%"></div>
                            </div>
                        </div>
                    `).join('')}
                    
                    <h6 class="mt-4">é¢˜ç›®ç±»å‹åˆ†å¸ƒ:</h6>
                    ${(typeData.type_distribution || []).map(item => `
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>${item.question_type}</span>
                                <span>${item.count} é¢˜ (${item.percentage?.toFixed(1) || 0}%)</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" 
                                     style="width: ${item.percentage || 0}%"></div>
                            </div>
                        </div>
                    `).join('')}
                `;
                
                document.getElementById('distribution-analysis').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½åˆ†å¸ƒåˆ†æå¤±è´¥:', error);
                showError('distribution-analysis', 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åŠ è½½æ‰€æœ‰é¢˜ç›®
        async function loadAllQuestions() {
            try {
                showLoading('questions-list', 'æ­£åœ¨åŠ è½½æ‰€æœ‰é¢˜ç›®...');
                
                // è·å–æ‰€æœ‰çŸ¥è¯†ç‚¹
                const kpResponse = await fetch(`${API_BASE_URL}/knowledge/search?keyword=`);
                const kpData = await kpResponse.json();
                
                let allQuestions = [];
                const questionIds = new Set();
                
                // ä»æ¯ä¸ªçŸ¥è¯†ç‚¹è·å–é¢˜ç›®
                for (const kp of kpData.results || []) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/questions/by-knowledge/${encodeURIComponent(kp.name)}`);
                        const data = await response.json();
                        
                        for (const item of data.questions || []) {
                            const question = item.question;
                            if (!questionIds.has(question.id)) {
                                questionIds.add(question.id);
                                allQuestions.push({
                                    ...question,
                                    knowledge_points: [kp.name],
                                    weight: item.weight
                                });
                            } else {
                                const existingQ = allQuestions.find(q => q.id === question.id);
                                if (existingQ && !existingQ.knowledge_points.includes(kp.name)) {
                                    existingQ.knowledge_points.push(kp.name);
                                }
                            }
                        }
                    } catch (error) {
                        console.warn(`è·å–çŸ¥è¯†ç‚¹ ${kp.name} çš„é¢˜ç›®å¤±è´¥:`, error);
                    }
                }
                
                // æ˜¾ç¤ºé¢˜ç›®
                const html = `
                    <div class="alert alert-success mb-4">
                        <h6><i class="fas fa-info-circle me-2"></i>é¢˜ç›®ç»Ÿè®¡</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>æ€»é¢˜ç›®æ•°:</strong> ${allQuestions.length}
                            </div>
                            <div class="col-md-4">
                                <strong>å·²æ ‡æ³¨:</strong> ${allQuestions.filter(q => q.knowledge_points?.length > 0).length}
                            </div>
                            <div class="col-md-4">
                                <strong>æ ‡æ³¨è¦†ç›–ç‡:</strong> ${allQuestions.length > 0 ? ((allQuestions.filter(q => q.knowledge_points?.length > 0).length / allQuestions.length) * 100).toFixed(1) : 0}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="45%">é¢˜ç›®å†…å®¹</th>
                                    <th width="10%">ç±»å‹</th>
                                    <th width="10%">éš¾åº¦</th>
                                    <th width="15%">ç­”æ¡ˆ</th>
                                    <th width="15%">å…³è”çŸ¥è¯†ç‚¹</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allQuestions.map((question, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>
                                            <div title="${question.content}">
                                                ${question.content.length > 80 ? 
                                                    question.content.substring(0, 80) + '...' : 
                                                    question.content
                                                }
                                            </div>
                                            ${question.analysis ? 
                                                `<small class="text-muted">ğŸ“ ${question.analysis.substring(0, 60)}...</small>` : 
                                                ''
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">${question.question_type}</span>
                                        </td>
                                        <td>
                                            <span class="badge ${getDifficultyColor(question.difficulty)}">
                                                ${getDifficultyLabel(question.difficulty)}
                                            </span>
                                        </td>
                                        <td>
                                            <code>${question.answer}</code>
                                        </td>
                                        <td>
                                            ${(question.knowledge_points || []).map(kp => 
                                                `<span class="badge bg-success me-1">${kp}</span>`
                                            ).join('')}
                                            ${(!question.knowledge_points || question.knowledge_points.length === 0) ? 
                                                '<span class="text-muted">æœªæ ‡æ³¨</span>' : ''
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('questions-list').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
                showError('questions-list', 'åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å·¥å…·å‡½æ•°
        function getDifficultyColor(difficulty) {
            const colors = {
                'easy': 'bg-success',
                'medium': 'bg-warning', 
                'hard': 'bg-danger'
            };
            return colors[difficulty] || 'bg-secondary';
        }
        
        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': 'ç®€å•',
                'medium': 'ä¸­ç­‰', 
                'hard': 'å›°éš¾'
            };
            return labels[difficulty] || 'æœªè®¾ç½®';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ®...');
            loadAccuracyAnalysis();
            loadCoverageAnalysis();
            loadDistributionAnalysis();
        });
    </script>
</body>
</html>
